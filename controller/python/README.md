# Python Controller

This python program allows you to control the robot from a (wireless) keyboard and receive a video stream from the camera. The program can run on any computer connected to the same network as the robot's phone. It was developed and tested on a Raspberry Pi 3 and a MacBook. Before following the steps below, make sure you have the [source code](https://github.com/isl-org/OpenBot#get-the-source-code) and navigate to the `controller` folder.

## Dependencies

We recommend to create a conda environment for OpenBot (if not already done). Instructions on installing conda can be found [here](https://docs.conda.io/projects/conda/en/latest/user-guide/install/). You can create a new environment with the following command:

```bash
conda create -n openbot python=3.7
```

If you do not want install the dependencies globally, activate your conda environment first:

```bash
conda activate openbot
```

Make sure you are in the folder `controller` within your local OpenBot repository. Now, you can install all the dependencies with the following command:

```bash
pip install -r requirements.txt
```

## Controlling the robot

NOTE: After a successful connection, it may not be possible to connect again unless the robot app is restarted.

The python scripts will wait for an incoming connection. On the phone with the robot app, go to the FreeRoam fragment and toggle the control mode to the phone icon. The robot will now try to connect to the Python script (same way as it would connect to the controller app). Alternatively, you can also use the DefaultActivity and select `Phone` as controller.

### Using Pygame

These scripts allow you to drive the robot using the keyboard similar to a car racing game.

Run the controller without video:

`python keyboard-pygame.py`

Run the controller with video:

`python keyboard-pygame.py --video`

Here is the usage:

```
    W:        Go forward
    S:        Go backward
    A:        Turn slightly left (while driving)
    D:        Turn slightly right (while driving)
    Q:        Rotate left
    E:        Rotate right

    M:        Drive mode
    N:        Toggle noise
    Left:     Left indicator
    Right:    Right indicator
    Up:       Cancel indicators
    Down:     Network mode
    SPACE:    Toggle logging
    ESC:      Quit
```

### Using Click

There is also a script for prototyping that allows setting the robot control in increments rather than controlling it dynamically. This script uses the click library and requires the terminal to stay in focus. 

Run the controller:

`python keyboard-click.py`

Here is the usage:

```bash
    W:        Increase speed
    S:        Decrease speed
    A:        Turn more left
    D:        Turn more right
    R:        Reset controls

    M:        Drive mode
    N:        Toggle noise
    Left:     Left indicator
    Right:    Right indicator
    Up:       Cancel indicators
    Down:     Network mode
    SPACE:    Toggle logging
    ESC:      Quit
```

# Python Controller with Remote RTP Video Stream and TCP/IP control
This python program allows to control the robot from a [joystick controller](joystick_controller.py) (you can also make this work with the keyboard controller), and receive [video stream](camera.py) from the camera via both mobile network connection and wifi connection. This program also allows to toggle data logging and autopilot on the robot's phone remotely. The program can run on computers that are necessarily in the same network as the robot's phone. It was developed and tested on Aruidno Uno and a Linux computer.

## Dependencies
In addition to the dependencies above, you need to first build OpenCV with GStreamer support, which will be used to decode RTP packets for video stream. Then you need to pip install the wheel file generated by the opencv build process. 

### GStreamer

You can find instructions for installing GStreamer for your OS [here](https://gstreamer.freedesktop.org/documentation/installing/index.html).

If you are using Mac, you can also install GStreamer using homebrew:
```
brew install gstreamer gst-plugins-base gst-plugins-good gst-plugins-bad gst-plugins-ugly gst-libav
```

### OpenCV

You can compile and install OpenCV with GStreamer support by executing the `install_opencv.sh` script from your terminal. If you are using Windows you can probably use [WSL](https://ubuntu.com/tutorials/install-ubuntu-on-wsl2-on-windows-10) (not tested).

```
sh install_opencv.sh
```

## Network Connection
1. Go to `Settings` and select `RTP` as the `Stream Mode`. 
2. Then type in your IP and port numbers for control and video stream. (Remote control uses TCP/IP, and video stream uses RTP)
3. Restart the app to load the new settings

**If your android device uses mobile network, and connects to the PC via Internet, then you need to do port forwarding on your router for both ports of remote control and remote video stream**. **!!!This must be done before you connect the android devide with the PC!!!**

## Using this remote controller

First connect your joystick with the computer.

Then, run the controller
```
python joystick_controller.py
```

Once the robot app successfully connects to the Python script, then run the video stream: 
```
python camera.py
```

Controller mapping
```
▲: autodrive
■: data logging
●: turn off the program
L3: speed down (press the left joystick)
R3: speed up (press the right joystick)
```